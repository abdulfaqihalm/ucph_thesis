---
title: 'GLORI EDA'
output:
  html_document: default
---

GLORI EDA
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using
# in your analysis in this code chunk.

library(Biostrings)
library(tidyverse)
library(readxl)
library(GenomicFeatures)
library(BSgenome)
library(fuzzyjoin)
library(rsample) # For kvold split
library(BSgenome.Hsapiens.NCBI.GRCh38)
library(TxDb.Hsapiens.UCSC.hg38.knownGene) #v44 Gencode
library(BSgenome.Mmusculus.UCSC.mm39) # For MEF 
library(tidyverse)
library(readxl)
library(biomaRt)
library(fuzzyjoin)
library(ggpubr) 
library(ggrepel)
library(ggplot2)
library(ggvenn)
library(ggsignif)
library(latex2exp)
# GFF/GTF related libs
library(rtracklayer) # Interacting with UCSC genome browser
library(GenomicRanges)
library(plyranges)
library(GenomicFeatures)
library(ensembldb)
# For dealing with bamfiles
library(Rsamtools)
# for genometrack plot 
library(Gviz)
# For printing latex table
library(kableExtra)
```

```{r echo=FALSE, Load_the_Data}
# Load the Data
## Can be changed
data_folder = '/Users/faqih/Documents/UCPH/Thesis/code/data/GLORI_data/'

overlap_repl_sites <- readxl::read_excel(paste(data_folder, 'identified_m6A_HEK29T.xlsx', sep=''))
overlap_repl_sites$Sites <- as.integer(overlap_repl_sites$Sites)
# Int conversion
overlap_repl_sites$AGCov_rep1 <- as.integer(overlap_repl_sites$AGCov_rep1)
overlap_repl_sites$AGCov_rep2 <- as.integer(overlap_repl_sites$AGCov_rep2)
overlap_repl_sites <- overlap_repl_sites |> 
  rename_with(tolower)
# Average over replicates
overlap_repl_sites <- overlap_repl_sites |> 
  mutate(avg_m6a = (m6a_level_rep1 + m6a_level_rep1)/2)


## Heat Shock MEF Data 
heat_shock_MEF_up <- readxl::read_excel(paste(data_folder, 
                                                       'heat_shock_m6A_sites_MEF.xlsx', 
                                                       sep=''),
                                                 sheet = 'HS UP m6A')
heat_shock_MEF_down <- readxl::read_excel(paste(data_folder, 
                                                       'heat_shock_m6A_sites_MEF.xlsx', 
                                                       sep=''),
                                                 sheet = 'HS Down m6A')
heat_shock_MEF_unchange <- readxl::read_excel(paste(data_folder, 
                                                       'heat_shock_m6A_sites_MEF.xlsx', 
                                                       sep=''),
                                                 sheet = 'HS un-change m6A')

heat_shock_MEF <- rbind(heat_shock_MEF_up, heat_shock_MEF_down, heat_shock_MEF_unchange)
# Int conversion
heat_shock_MEF$start <- as.integer(heat_shock_MEF$start)
heat_shock_MEF$end <- as.integer(heat_shock_MEF$end)
heat_shock_MEF$log10pvalue <- as.numeric(heat_shock_MEF$log10pvalue)


## Hypoxia HeLa Data 
hypoxia_HeLa_up <- readxl::read_excel(paste(data_folder, 
                                              'hypoxia_m6A_sites_HeLa.xlsx', 
                                              sep=''),
                                        sheet = 'Hypoxia UP m6A')
hypoxia_HeLa_down <- readxl::read_excel(paste(data_folder, 
                                                'hypoxia_m6A_sites_HeLa.xlsx', 
                                                sep=''),
                                          sheet = 'Hypoxia Down m6A')
hypoxia_HeLa_unchange <- readxl::read_excel(paste(data_folder, 
                                                    'hypoxia_m6A_sites_HeLa.xlsx', 
                                                    sep=''),
                                              sheet = 'Hypoxia un-change m6A')

hypoxia_HeLa <- rbind(hypoxia_HeLa_up, hypoxia_HeLa_down, hypoxia_HeLa_unchange)
# Int conversion
hypoxia_HeLa$start <- as.integer(hypoxia_HeLa$start)
hypoxia_HeLa$end <- as.integer(hypoxia_HeLa$end)
hypoxia_HeLa$log10pvalue <- as.numeric(hypoxia_HeLa$log10pvalue)
# Renaming direction since there is two values: Hypoxia and hypoxia 
hypoxia_HeLa$direction <- str_to_sentence(hypoxia_HeLa$direction)

# renaming
heat_shock_MEF <- heat_shock_MEF |> 
  rename('chr'='seqnames')
hypoxia_HeLa <- hypoxia_HeLa |> 
  rename('chr'='seqnames')
 
summary_data <- rbind( hypoxia_HeLa |> 
                         group_by(direction, label) |> 
                         count() |> ungroup() |> 
                         arrange(label),
                       heat_shock_MEF |>
                         group_by(direction, label) |> 
                         count() |> ungroup() |> 
                         arrange(label)) 

summary_data <- summary_data |>
  pivot_wider(names_from = label, values_from = n) |>
  rowwise(direction) |>
  mutate(total = sum(c(`Down-regulated m6A`,`Unchanged m6A`, `Up-regulated m6A`))) |>
  ungroup() |> 
  rename('label'='direction')

summary_data <- rbind(summary_data, list('HEK293T m6A Overlap Repl Sites', NA, NA, NA, dim(overlap_repl_sites)[1]))

print(summary_data)

rm(hypoxia_HeLa_up, hypoxia_HeLa_down, hypoxia_HeLa_unchange)
rm(heat_shock_MEF_up, heat_shock_MEF_down, heat_shock_MEF_unchange)
```

NOTE!!!: We can see there is a difference between the data provided and the GLORI paper. It seems that the Hypoxia and HS data are somehow interchanged.


# Counting m6A for each chromosomes 
```{r}
## For plots or analysis
chr_order <- c('chr1','chr2','chr3','chr4','chr5','chr6','chr7',
                            'chr8','chr9','chr10','chr11','chr12','chr13','chr14',
                            'chr15','chr16','chr17','chr18','chr19','chr20','chr21',
                            'chr22','chrX','chrY','chrM') 
overlap_repl_count <- overlap_repl_sites |> 
  group_by(chr) |> 
  count() |> 
  mutate(data='repl_sites_HEK293T')
HeLa_count <- hypoxia_HeLa |> 
  group_by(chr) |> 
  count() |> 
  mutate(data='HeLa_hypox')
MEF_count <- heat_shock_MEF |> 
  group_by(chr) |> 
  count() |> 
  mutate(data='MEF_heat')

count_data <- rbind(HeLa_count, MEF_count, overlap_repl_count)
rm(HeLa_count, MEF_count, overlap_repl_count)


count_data <- count_data |> 
  pivot_wider(names_from = data, values_from = n) |> 
  mutate(chr = factor(chr, levels = chr_order)) |> 
  arrange(chr)

print(count_data)

```

Notice different count of m6A sites for each of the cell type of different conditions. In heat_shock, MEF doesn't have any m6A data at chr20, chr21, and chr22. It might be due to several reasons which were not covered on the paper. First, the sites might not have site either on the control or on the treatment environment. Second, it might be that those sites don't have any m6A sites.

However, when we see the intersection of replicates within a normal condition of HEK293T cells, those chromosomes have m6A site. Therefore, the former hypothesis might be the reason.

```{r}
# Create the density plot and the distribution of the value 
ggplot(overlap_repl_sites, aes(x = avg_m6a*100)) +
  geom_density(color = "brown", size = 1) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()) +
  labs(x = "Methylation level (%)", y = "Density")

ggplot(overlap_repl_sites, aes(x = 'overlap sites', y = avg_m6a*100)) +  
  geom_violin(aes(fill="orange")) +     
  geom_boxplot(width=0.1) + 
  theme_bw() + 
  labs(y = "Methylation levle (%)")
```
We can see that the median of the m6A rate is ~40%. In addition, most of the sites are considered not to have methylation modification (<50%).


In addition, we see that neither HeLa hypoxia nor the MEF heat shock data contain gene annotation at it. Thus, we will annotate it using the longest transcript using the GLORI annotation tools found on its GitHub page. 


# Running the GLORI annotation pipeline using p.14 NCBI GTF file
```{bash}
# This script is used to create the annotation file for the human genome
# The annotation python scripts were downloaded from GLORI GitHub repository

# Download the human genome annotation file
#mkdir -p data/annot_ref/
#wget  https://ftp.ncbi.nlm.nih.gov/refseq/H_sapiens/annotation/annotation_releases/GCF_000001405.40-RS_2023_03/GCF_000001405.40_GRCh38.p14_assembly_report.txt 

#wget https://ftp.ncbi.nlm.nih.gov/refseq/H_sapiens/annotation/annotation_releases/GCF_000001405.40-RS_2023_03/GCF_000001405.40_GRCh38.p14_genomic.gtf.gz 

#conda activate thesis

# Patch the GTF file based on the assembly report
#python GLORI/get_anno/change_UCSCgtf.py -i data/annot_ref/GCF_000001405.40_GRCh38.p14_genomic.gtf -j data/annot_ref/GCF_000001405.40_GRCh38.p14_assembly_report.txt -o data/annot_ref/GCF_000001405.40_GRCh38.p14_genomic.gtf_change2Ens

# Get exon start and end
#python GLORI/get_anno/gtf2anno.py -i data/annot_ref/GCF_000001405.40_GRCh38.p14_genomic.gtf_change2Ens -o data/annot_ref/GCF_000001405.40_GRCh38.p14_genomic.gtf_change2Ens.tbl

# Filtering the unknown transcript
#awk '$3!~/_/&&$3!="na"' data/annot_ref/GCF_000001405.40_GRCh38.p14_genomic.gtf_change2Ens.tbl | sed '/unknown_transcript/d'  > data/annot_ref/GCF_000001405.40_GRCh38.p14_genomic.gtf_change2Ens.tbl2

# Get the longest transcript for each gene
#python GLORI/get_anno/selected_longest_transcrpts_fa.py -anno data/annot_ref/GCF_000001405.40_GRCh38.p14_genomic.gtf_change2Ens.tbl2  --outname_prx data/annot_ref/GCF_000001405.39_GRCh38.p13_rna2
```



# Get gene annotation 
```{r}
# Filtered LONGEST TRANSCRIPT from h38.p14 GTF (GCF_000001405.40_GRCh38.p14_genomic.gtf.gz)
# See GLORI Github page for the pipeline of filtering longest transcript

longest_transcript <- read.table('data/annot_ref/GCF_000001405.40_GRCh38.p14_genomic.gtf.translength.longest.trans',
                                 col.names=c('chr','start','end','length',
                                             'gene','strand','transcript'), skip=1)
hypoxia_HeLa_annot <- fuzzyjoin::genome_join(hypoxia_HeLa, longest_transcript, 
                                             by = c("chr", "start", "end"), 
                       mode = "left") 

hypoxia_HeLa_annot <- hypoxia_HeLa_annot |> 
  dplyr::select(!c('chr.y')) |> 
  rename('chr'='chr.x', 'start'='start.x', 'end'='end.x',
         'max_start'='start.y', 'max_end'='end.y')


heat_shock_MEF_annot <- fuzzyjoin::genome_join(heat_shock_MEF, longest_transcript, 
                                             by = c("chr", "start", "end"), 
                                             mode = "left") 

heat_shock_MEF_annot <- heat_shock_MEF_annot |> 
  dplyr::select(!c('chr.y')) |> 
  rename('chr'='chr.x', 'start'='start.x', 'end'='end.x',
         'max_start'='start.y', 'max_end'='end.y')

print(hypoxia_HeLa_annot)
print(heat_shock_MEF_annot)


```

We can see that there are several regions which have null value of the join result. It might be that the region is actually not containing any gene i.e. chr1  10806198 10806198 on heat shock.  
```{r}
# There might be several genes on a position. Check: 
print(heat_shock_MEF_annot |> dplyr::group_by(chr, start, end) |> count() |> arrange(desc(n)))
print(heat_shock_MEF_annot |> dplyr::filter(chr=='chr5', start==141410368, end==141410368))
print(hypoxia_HeLa_annot |> dplyr::group_by(chr, start, end) |> count() |> arrange(desc(n)))
print(hypoxia_HeLa_annot |> dplyr::filter(chr=='chr12', start==10996111, end==10996111))

# Count of non-annotated pos: 
print(heat_shock_MEF_annot |> dplyr::filter(is.na(gene)))
print(hypoxia_HeLa_annot |> dplyr::filter(is.na(gene)))
```


# %m6A Distribution of Hypoxia and HS 
```{r}

heat_shock_dist <- heat_shock_MEF |> 
  dplyr::select(c('meth_case','meth_control')) |> 
  pivot_longer(cols = starts_with('meth_'), names_to = 'label',
               values_to = 'm6A_rate') |> 
  mutate(data='HeLa_Hypoxia')

hypoxia_HeLa_dist <- hypoxia_HeLa |> 
  dplyr::select(c('meth_case','meth_control')) |> 
  pivot_longer(cols = starts_with('meth_'), names_to = 'label',
               values_to = 'm6A_rate') |> 
  mutate(data='MEF_Heat_Shock')

dist_data <- rbind(heat_shock_dist, hypoxia_HeLa_dist)

comps <- c('meth_control', 'meth_case')
dist_plot <- ggplot(dist_data,aes(x= label, y = m6A_rate)) + 
  geom_violin(aes(fill=label)) +     
  geom_boxplot(width=0.1) +  ggtitle(label = "Distribution Control vs Case") +
  facet_grid(cols = vars(data)) + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme_bw() +
  stat_compare_means(method = "wilcox.test") # Add two-sided test

dist_plot 

dist_data |> 
  group_by(data, label) |> 
  summarise(mean(m6A_rate), .groups = 'drop')
```

From the distribution of m6A rate per cases, we can see that Hypoxia in HeLa cell shifts the distribution of m6A_rate to be significantly higher compared to control (p-val <0.05). Moreover, there is also significant (p-val <0.05)  different in m6A_rate between the Heat Shock treated and control group. However, this overall different in distribution does not depict the stoichiometry since there might be increment of methylation on a particular regions and also decrement of methylation on other regions.


Next, we will show the volcano plot and analyse the significant genes
```{r}
heat_shock_delta_m6A <- heat_shock_MEF_annot |> 
  dplyr::select(c('meth_diff','log10pvalue', 'label', 'gene')) |> 
  mutate(data='HeLa_Hypoxia')

hypoxia_delta_m6A <- hypoxia_HeLa_annot |> 
  dplyr::select(c('meth_diff','log10pvalue', 'label', 'gene')) |> 
  mutate(data='MEF_Heat_Shock')

delta_m6A_data <- rbind(heat_shock_delta_m6A, hypoxia_delta_m6A)


ggplot(data = delta_m6A_data, mapping = aes(x = meth_diff, y = log10pvalue)) + 
  geom_point(alpha=0.25, mapping = aes(colour = label), size = 0.8)  +
  ylim(0, 20) +
  # From the paper: When the absolute change of m6A modification level between untreated and stressed was greater than 15% and the P value was less than 0.05, it was considered to be a dynamic m6A.
  geom_vline(xintercept=c(-15,15),lty=2,col="black") + # this for the 15% change both down and up regulated
  geom_hline(yintercept = -log10(0.05),lty=4,col="black") + # for the <0.05 p-value
  geom_text_repel(data = delta_m6A_data[delta_m6A_data$label!='Unchanged m6A' & !is.na(delta_m6A_data$gene),]
                  , mapping = aes(label = gene), max.overlaps = 35, size = 2,
                  point.size = NA) +
  scale_color_manual(values=c("blue", "gray", "red")) +
  #annotate("text", x = 65, y = 2, label = paste0("n = ", delta_m6A_data |>  count()), size = 3, fontface = "bold", color = "red") + # Label to horizontal cut-off line.
  facet_wrap(vars(data)) + 
  labs(x="delta %m6A",
       y=TeX(r"($-log_{10}p$)"),
       title="Stress Induced Response")  +
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5), 
        legend.position="bottom", 
        legend.title = element_blank())
```

```{r}
# Print HSPA related genes 
print(heat_shock_MEF_annot |> 
        drop_na() |> 
        dplyr::select(c(chr,start,end,meth_diff,log10pvalue,label,gene)) |> 
        dplyr::filter(grepl('(?i)hsp|HSPA|IRS3|VEGFA|EGLN', gene)) |> 
        arrange(chr, start, end)) 
  

# Print Hypoxia related genes 
print(hypoxia_HeLa_annot |> 
        drop_na() |> 
        dplyr::select(c(chr,start,end,meth_diff,log10pvalue,label,gene)) |> 
        dplyr::filter(grepl('HSPA|IRS3|VEGFA|EGLN', gene)) |> 
        arrange(chr, start, end)) 
```



```{r}
# Print HSPA related genes 
print(heat_shock_MEF_annot |> 
        drop_na() |> 
        dplyr::select(c(chr,start,end,meth_diff,log10pvalue,label,gene)) |> 
        dplyr::filter(grepl('HSPA', gene)) |> 
        dplyr::arrange(chr, start, end)) 
  

# Print Hypoxia related genes 
print(hypoxia_HeLa_annot |> 
        drop_na() |> 
        dplyr::select(c(chr,start,end,meth_diff,log10pvalue,label,gene)) |> 
        dplyr::filter(grepl('IRS3|VEGFA|EGLN', gene)) |> 
        arrange(chr, start, end)) 
```




# Looking at the GRE data. HeLA and Hypox related RAW Data
Notes: GLORI used deep sequencing (~390,000,000 uniquely mapped reads, or ~140× coverage).
COLUMNS: 
CR --> Conversion rate for genes 
AGcov     --> reads coverage with A and G
Acov      --> read coverage with A
GeneCov   --> mean coverage for the whole genome 
Ratio     --> A rate for the sites (methylation level)
Pvalue    --> test for A rate based on the background (binomial distribution or Poisson distribution, to each of them on the basis of the gene-specific A-to-G conversion rate)
P_adjust  --> FDR adjusted Pvalue (BH method)

The number of m6A reads for each detected m6A site was calculated as A rate × cov- erage. The methylation level for one gene was then calculated as: the sum of m6A reads of all m6A sites divided by the sum of coverage of all sites in the longest isoform.

# Prepare data
```{r}
data_path <- '/Users/faqih/Documents/UCPH/Thesis/code/data/'

# A rate serving as the m6A level
# Has transcript and gene info
GRE_folder = '/Users/faqih/Documents/UCPH/Thesis/papers/GLORI/GLORI_data/GSE210563_RAW/'
hela_1 <- read.csv(paste0(GRE_folder,'GSM6432595_Hela-1_35bp_m2.totalm6A.FDR.csv'), sep = "\t")
hela_2 <- read.csv(paste0(GRE_folder,'GSM6432596_Hela-2_35bp_m2.totalm6A.FDR.csv'), sep = "\t")
mef_1 <- read.csv(paste0(GRE_folder,'GSM6432601_MEF-1_35bp_m2.totalm6A.FDR.csv'), sep = "\t")
mef_2 <- read.csv(paste0(GRE_folder,'GSM6432602_MEF-2_35bp_m2.totalm6A.FDR.csv'), sep = "\t")
hypox_hela_1 <- read.csv(paste0(GRE_folder,'GSM6432598_hypoxia-1_35bp_m2.totalm6A.FDR.csv'), sep = '\t')
hypox_hela_2 <- read.csv(paste0(GRE_folder,'GSM6432599_hypoxia-2_35bp_m2.totalm6A.FDR.csv'), sep = '\t')
hs_mef_1 <- read.csv(paste0(GRE_folder,'GSM6432604_HS-1_35bp_m2.totalm6A.FDR.csv.gz'), sep = '\t')
hs_mef_2 <- read.csv(paste0(GRE_folder,'GSM6432605_HS-2_35bp_m2.totalm6A.FDR.csv.gz'), sep = '\t')

hela_raw_intrsct <- hela_1 |> 
  dplyr::inner_join(hela_2, by=c("Chr", "Sites")) |> 
  dplyr::rename(Strand=Strand.x, Gene=Gene.x) |> 
  dplyr::select(Chr, Sites, Strand, Gene, Ratio.x, Ratio.y) |> 
  rowwise() |> 
  mutate(meth_ctrl_mean = mean(c_across(c('Ratio.x', 'Ratio.y')))) |> 
  ungroup() |> 
  dplyr::select(!c(Ratio.x, Ratio.y))
hela_raw_hypoxia_intrsct <-  hypox_hela_1 |> 
  dplyr::inner_join(hypox_hela_2, by=c("Chr", "Sites")) |> 
  dplyr::rename(Strand=Strand.x, Gene=Gene.x) |> 
  dplyr::select(Chr, Sites, Strand, Gene, Ratio.x, Ratio.y) |> 
  rowwise() |> 
  mutate(meth_case_mean = mean(c_across(c('Ratio.x', 'Ratio.y')))) |> 
  ungroup() |> 
  dplyr::select(!c(Ratio.x, Ratio.y))

hela_hypoxia_intrsct <- hela_raw_intrsct |> 
  dplyr::full_join(hela_raw_hypoxia_intrsct, by=c("Chr", "Sites")) |> 
  dplyr::mutate(strand = ifelse(is.na(Strand.x),Strand.y,Strand.x),
                meth_control = ifelse(is.na(meth_ctrl_mean), 0, meth_ctrl_mean),
                meth_case = ifelse(is.na(meth_case_mean), 0, meth_case_mean),
                end = Sites,
                gene= ifelse(is.na(Gene.x), Gene.y, Gene.x)) |> 
  dplyr::rename(seqnames=Chr, start=Sites) |> 
  dplyr::select(c(seqnames, start, end, strand, gene, meth_case, meth_control))

#Sanity check, should be zero --> no duplicate sites, thus safe for training-test split
hela_raw_hypoxia_intrsct |> dplyr::group_by(Chr, Sites) |> dplyr::summarise(count=dplyr::n()) |> dplyr::filter(count>1)
  

#NOTES:
#   hypox_hela_2 |>  inner_join(heat_shock_MEF, by = dplyr::join_by(Chr==chr, Sites==start)) RETURNING SMALL NUMBER OF SITES (4)
#   hypox_hela_2 |>  inner_join(hypoxia_HeLa, by = dplyr::join_by(Chr==chr, Sites==start)) RETURNING >80K sites. THUS HYPOXIA_HELA IS INDEED HYPOXIA IN THE DATA? 
# This is conversely the sdame for the MEF-HS.
# Conclusion: the supplementary tables are indeed true. The publisehd figures' labels were False? 
# In addition when doing: 
# hela_1 |> inner_join(hela_2, by = dplyr::join_by(Chr==Chr, Sites==Sites)) |> inner_join(hypox_hela_1, by = dplyr::join_by(Chr==Chr, Sites==Sites)) |> inner_join(hypox_hela_2, by = dplyr::join_by(Chr==Chr, Sites==Sites)) 
# We get 74,032 intersection sites across the control and hypox groups.

# Note: ELSE for gene_name and transcript represents unknown gene and/or transcript.
# When the absolute change of m6A modification level between untreated and stressed was greater than 15% and the P value was less than 0.05, it was considered to be a dynamic m6A.
```

```{r}
print(dim(hela_1))
print(dim(hela_2))
print(dim(hypox_hela_1))
print(dim(hypox_hela_2))
```

```{r}
venn_hel_data <- list(
  control_1 = paste0(hela_1$Chr,"_",hela_1$Sites),
  control_2 = paste0(hela_2$Chr,"_", hela_2$Sites),
  hypoxia_1 = paste0(hypox_hela_1$Chr,"_", hypox_hela_1$Sites),
  hypoxia_2 = paste0(hypox_hela_2$Chr,"_", hypox_hela_2$Sites)
)

ggvenn::ggvenn(
  venn_hel_data, 
  fill_color = c("#0073C2FF", "#EFC000FF", "#868686FF", "#CD534CFF"),
  stroke_size = 0.5, set_name_size = 4
  )


```

## SUPP FIGURE 1

```{r}

venn_hel_data <- list(
  hypoxia_1 = paste0(hypox_hela_1$Chr,"_", hypox_hela_1$Sites),
  hypoxia_2 = paste0(hypox_hela_2$Chr,"_", hypox_hela_2$Sites)
)

ggvenn::ggvenn(
  venn_hel_data, 
  fill_color = c("#0073C2FF", "#EFC000FF"),
  stroke_size = 0.5, set_name_size = 4, auto_scale = TRUE
  )
```
```{r}
venn_hel_data <- list(
  control_1 = paste0(hela_1$Chr,"_",hela_1$Sites),
  control_2 = paste0(hela_2$Chr,"_", hela_2$Sites)
)

ggvenn::ggvenn(
  venn_hel_data, 
  fill_color = c("#868686FF", "#CD534CFF"),
  stroke_size = 0.5, set_name_size = 4, auto_scale = TRUE
  )
```



```{r}
ggplot() +
  geom_histogram(data = hypox_hela_1, aes(x=Ratio), fill = "red", alpha=0.2
                 ) +
  geom_histogram(data = hypox_hela_2, aes(x=Ratio), fill = "blue", alpha=0.2
                 ) +
  geom_histogram(data = hela_1, aes(x=Ratio), fill = "orange", alpha=0.2
                 ) +
  geom_histogram(data = hela_2, aes(x=Ratio), fill = "green", alpha=0.2
                 ) +
  theme_bw()
```



```{r}

venn_hel_data <- list(
  control_1 = paste0(hela_1$Chr,"_",hela_1$Sites),
  control_2 = paste0(hela_2$Chr,"_", hela_2$Sites),
  hypoxia_1 = paste0(hypox_hela_1$Chr,"_", hypox_hela_1$Sites),
  hypoxia_2 = paste0(hypox_hela_2$Chr,"_", hypox_hela_2$Sites)
)

venn_hel_intrsct_data <- list(
  control_raw_intersect =  base::intersect(venn_hel_data$control_1, venn_hel_data$control_2),
  hypoxia_raw_intersect = base::intersect(venn_hel_data$hypoxia_1, venn_hel_data$hypoxia_2)
)
ggvenn::ggvenn(
  venn_hel_intrsct_data, 
  fill_color = c("#0073C2FF","#CD534CFF"),
  stroke_size = 0.5, set_name_size = 4, auto_scale = TRUE
  )
```


```{r}
# Subject to change
DATA_FOLDER <- '/Users/faqih/Documents/UCPH/Thesis/code/data/'
data_path <- '/Users/faqih/Documents/UCPH/Thesis/code/data/'
# ===== TxD Related ===== #
# Get annotation to the txDb (including the validity checking)
human_txDb <- makeTxDbFromGFF(paste0(DATA_FOLDER, 'annot_ref/gencode.v45.annotation.gtf'))
# Get from rtracklayer to extract metadata
gtf <- rtracklayer::import.gff(con=paste0(DATA_FOLDER, 'annot_ref/gencode.v45.annotation.gtf'), 
                               format="gtf", genome="GRCh38.p14")

metadata <- as.tibble(elementMetadata(gtf)[ , c("gene_id", "gene_name", 
                                                "gene_type", "transcript_id", 
                                                "transcript_name")])
metadata <- na.omit(metadata)
metadata <- metadata[!duplicated(metadata), ]

# Tx
human_Tx <- transcripts(human_txDb)
# Transcript length summary
human_Tx_length <- transcriptLengths(human_txDb,
                                     with.cds_len=TRUE, with.utr5_len=TRUE, with.utr3_len=TRUE)


human_Tx_data <- S4Vectors::merge(human_Tx, metadata, 
                                  by.x = 'tx_name', by.y = 'transcript_id', all.x=TRUE)
human_Tx_data <- S4Vectors::merge(human_Tx_data, human_Tx_length |> 
                                    dplyr::select(tx_name, nexon, tx_len,cds_len, utr5_len, utr3_len), 
                                  by.x = 'tx_name', by.y = 'tx_name', all.x=TRUE)

# Filtering the longest transcript (width) only for each gene
# it still contain numbers of non mRNA gene: i.e. rRNA, tRNA, Mt_RNA, etc.
human_Tx_data_longest <- human_Tx_data |> 
  dplyr::group_by(gene_id) |> 
  dplyr::filter(width == max(width)) |> 
  # Since several transcripts could have the same start and end.
  # need to filter by tx_len (CDS + UTRs)
  dplyr::filter(tx_len == max(tx_len)) |> 
  dplyr::ungroup() |> 
  # STILL CONTAIN DUPLICATE. CHECK: human_Tx_data_longest |>  dplyr::inner_join(human_Tx_data_longest |> dplyr::select(gene_name, gene_type) |> group_by(gene_name) |> dplyr::summarise(count = dplyr::n()) |> dplyr::filter(count>1), by=c("gene_name")) |> arrange(gene_name,tx_id)
  # Thus add filter below
  dplyr::group_by(gene_name) |>
  dplyr::filter(cds_len == max(cds_len)) |> 
  dplyr::ungroup() |> 
  # Arbitary filter by tx_name since they already have the save width, cds len
  dplyr::group_by(gene_name) |>
  dplyr::filter(tx_name == max(tx_name)) |> 
  dplyr::ungroup() |> 
  dplyr::group_by(gene_name) |>
  dplyr::filter(gene_id == max(gene_id)) |> 
  dplyr::ungroup() |> 
  dplyr::select(!c(tx_id)) |> 
  dplyr::rename('tx_name'='transcript_name', 'tx_id'='tx_name') |> 
  dplyr::relocate(c('tx_id','tx_name','nexon','tx_len'), 
                  .after = c('strand'))
# FILTERING PSEUDOGENE, MISC, VAULT, TO BE CONFIRMED (TEC), ANTIBODY GENES 
human_Tx_data_longest |> dplyr::filter(!grepl('pseudogene|misc_RNA|vault|TR_|IG|TEC|artifact', gene_type)) |> dplyr::distinct(gene_type)

### Sanity chec. Should be zero! 
human_Tx_data_longest |>  dplyr::inner_join(human_Tx_data_longest |> dplyr::select(gene_name, gene_type) |> group_by(gene_name) |> dplyr::summarise(count = dplyr::n()) |> dplyr::filter(count>1), by=c("gene_name")) |> arrange(gene_name,tx_id)
# NOTE: "ELSE" is not known gene from GLORI pipeline



# ===== Joining Hypoxia with Annot ===== #
#Here we want to know the longest transcript which annotated from GLORI
#Expected several NA gene_type from known gene i.e. LOC112268063
annotated_hypoxia_Hela <- hela_hypoxia_intrsct |> 
  dplyr::left_join(human_Tx_data_longest |> 
                     dplyr::select(gene_name, gene_type, tx_id, width, start, end, strand),
                                                                   by=dplyr::join_by(gene==gene_name)) |>
  dplyr::rename(start = start.x, end = end.x, strand = strand.x, 
                start_gene = start.y, end_gene = end.y, strand_gene = strand.y)
  

# We want to still annotate several sites which might not joined with the longest transcript data 
# to get the promoters.
# Note: the non-joined sites are those which have gene_name == "ELSE" and other genes which somehow couldn't be found 
# from the TxDb. There are ~33,238 stes: annotated_hypoxia_Hela |> dplyr::filter(is.na(start_gene))
# Other named gene from GLORI migh not be joined due to change in the name. Hence, we will join it by location and take
# the longest transcript for each gen
annotated_hypoxia_Hela_temp_na <- (annotated_hypoxia_Hela |> dplyr::filter(is.na(start_gene)) |> 
     dplyr::select(!c(gene_type, tx_id, width, start_gene, end_gene, strand_gene)) |> dplyr::mutate(site=start)) |> 
  dplyr::left_join(human_Tx_data_longest |> 
                     #dplyr::filter(!grepl('vault|TEC|artifact', gene_type)) |> 
                     dplyr::select(seqnames, start, end, strand, gene_name, gene_type, tx_id,tx_len,width, utr5_len, utr3_len),
                   by=dplyr::join_by(seqnames==seqnames, site>=start, site<=end)) |> 
  dplyr::rename(start = start.x, end = end.x, strand = strand.x, 
                start_gene = start.y, end_gene = end.y, strand_gene = strand.y) |> 
  group_by(seqnames,start,end) |> 
  dplyr::mutate(tx_len=ifelse(is.na(tx_len), 0, tx_len)) |> 
  dplyr::filter(tx_len == max(tx_len)) |> 
  dplyr::ungroup() 


# There are around 7,086  sites which still can't be joined
# where 6,508 sites came from "ELSE" genes. annotated_hypoxia_Hela_temp_na |> dplyr::filter(is.na(gene_name))
# Need to check from the other transcript version. Not only the longest.
# However, if it is joined with several genes, take the longest tx_len.
annotated_hypoxia_Hela_temp_na2 <- 
  annotated_hypoxia_Hela_temp_na |> 
  dplyr::filter(is.na(gene_name)) |> 
  dplyr::select(c(seqnames,start,end,strand,gene,meth_case,meth_control,site)) |> dplyr::left_join(  
    human_Tx_data |> 
      dplyr::select(seqnames, start, end, strand, gene_name, gene_type, tx_name,tx_len,width,  utr5_len, utr3_len) |> 
      dplyr::rename(tx_id=tx_name),
    by=dplyr::join_by(seqnames==seqnames, site>=start, site<=end)
  )|> 
  dplyr::rename(start = start.x, end = end.x, strand = strand.x, 
                start_gene = start.y, end_gene = end.y, strand_gene = strand.y) |> 
  group_by(seqnames,start,end) |> 
  dplyr::mutate(tx_len=ifelse(is.na(tx_len), 0, tx_len)) |> 
  dplyr::filter(tx_len == max(tx_len)) |> 
  dplyr::ungroup() 
# Still 6077 sites not joind! annotated_hypoxia_Hela_temp_na2 |> dplyr::filter(is.na(start_gene))  
# detail 
# annotated_hypoxia_Hela_temp_na2 |> dplyr::filter(is.na(start_gene)) |> mutate(flag = case_when(meth_case==0 ~ "control", meth_control==0 ~ "case", .default= "both")) |> group_by(flag) |> count()

dplyr::bind_rows(annotated_hypoxia_Hela |> dplyr::filter(!is.na(start_gene)), 
                 )

temp <- annotated_hypoxia_Hela_temp_na |> 
  dplyr::filter(!is.na(gene_name)) |> 
  dplyr::bind_rows(annotated_hypoxia_Hela_temp_na2) |> 
  dplyr::mutate(gene=ifelse(!is.na(start_gene) & gene!=gene_name, gene_name, gene)) |> 
  dplyr::select(c(seqnames, start, end, strand, gene, meth_case, meth_control, gene_type, tx_id, width, start_gene, end_gene, strand_gene))


# Final annotation
annotated_hypoxia_Hela <- dplyr::bind_rows(annotated_hypoxia_Hela |> dplyr::filter(!is.na(start_gene)), 
                 temp) |> 
  dplyr::arrange(seqnames,start,end)


# All methylation data if it's available has minimum of 10% 
min(annotated_hypoxia_Hela |> dplyr::filter(meth_case!=0) |> pull(meth_case))
min(annotated_hypoxia_Hela |> dplyr::filter(meth_control!=0) |> pull(meth_control))

# Buffer
temp_annotated_hypoxia_Hela <- annotated_hypoxia_Hela



annotated_hypoxia_Hela <- temp_annotated_hypoxia_Hela
# Since we want to know the promoters, we drop the unkonwn start_gene sites
annotated_hypoxia_Hela <- annotated_hypoxia_Hela |> dplyr::filter(!is.na(start_gene))

```

```{r}

case_filtered <- annotated_hypoxia_Hela |> dplyr::filter(meth_case!=0) |> dplyr::select(seqnames, start) 
control_filtered <- annotated_hypoxia_Hela |> dplyr::filter(meth_control!=0) |> dplyr::select(seqnames, start)

venn_hel_data <- list(
  control = paste0(case_filtered$seqnames,"_",case_filtered$start),
  hypoxia = paste0(control_filtered$seqnames,"_", control_filtered$start)
)


ggvenn::ggvenn(
  venn_hel_data, 
  fill_color = c("#0073C2FF","#CD534CFF"),
  stroke_size = 0.5, set_name_size = 4, auto_scale = TRUE
  )
```



```{r}

plot_data <- annotated_hypoxia_Hela |> 
  dplyr::select(meth_case, meth_control, gene_type) |> 
  tidyr::pivot_longer(cols=c(meth_case, meth_control), names_to='data', values_to='m6A_rate') 
ggplot(data = plot_data, mapping = aes(x=data, y=m6A_rate, fill=data)) + 
       geom_violin(alpha=0.5, position = position_dodge(width = .75),size=1,color=NA, legend=FALSE) +
      ggsignif::stat_signif(comparison=list(c("meth_case", "meth_control")),map_signif_level = TRUE ) +
       geom_boxplot(notch = TRUE,  outlier.size = -1, lwd=1, alpha = 0.5,show.legend = F, width = 0.3) +
      # geom_point( shape = 21,size=2, position = position_jitterdodge(), color="black",alpha=1)+
       # ggbeeswarm::geom_quasirandom(shape = 21,size=0.5, dodge.width = .75, alpha=.2,show.legend = F)+
       theme_minimal()+
       ylab(  c("m6A level")  )  +
       xlab(  c("Condition")  )  +
       rremove("legend.title")+
       theme(#panel.border = element_rect(colour = "black", fill=NA, size=2),
             legend.position = "none")+
       font("xylab",size=15)+  
       font("xy",size=15)+ 
       font("xy.text", size = 15) +  
       font("legend.text",size = 15)+
       guides(fill = guide_legend(override.aes = list(alpha = 1,color="black"))) 
```


```{r}
metagene_data <- annotated_hypoxia_Hela |> 
  dplyr::left_join(human_Tx_data_longest |> 
                      dplyr::select(tx_id, utr5_len, utr3_len), by=dplyr::join_by(tx_id))
```



```{r}
metagene_data_mrna <- metagene_data |> 
  # somehow there are sties which don't have utr3_len
  dplyr::filter(utr5_len > 0 & utr3_len > 0 & ((start >= start_gene & end<=end_gene & strand_gene == "+") | (start <= start_gene & end>=end_gene & strand_gene == "-")) ) |> 
  dplyr::mutate(cds_start = ifelse(strand_gene == "+", start_gene + utr5_len, start_gene - utr5_len),
                utr3_start = ifelse(strand_gene == "+", end_gene - utr3_len, end_gene + utr3_len)) |> 
  dplyr::mutate(pos_flag = ifelse(strand_gene == "+", 
                                  case_when(start < cds_start ~ "5UTR",
                                            start >= cds_start & start < utr3_start ~ "CDS",
                                            start >= utr3_start ~ "3UTR"),
                                  case_when(start > cds_start ~ "5UTR", 
                                            start <= cds_start & start > utr3_start ~ "CDS",
                                            start <= utr3_start ~ "3UTR"))) |> 
  dplyr::mutate(pos_fraction = ifelse(strand_gene == "+",
                                      case_when(pos_flag == "5UTR" ~ (start-start_gene)/utr5_len, 
                                                pos_flag == "3UTR" ~ (start-utr3_start)/utr3_len,
                                                pos_flag == "CDS" ~ (start-cds_start)/(utr3_start-cds_start)),
                                      
                                      case_when(pos_flag == "5UTR" ~ (start_gene-start)/utr5_len,
                                                pos_flag == "3UTR" ~ (utr3_start-start)/utr3_len,
                                                pos_flag == "CDS" ~ (cds_start-start)/(utr3_start-cds_start))
                                      ) )  #923923   924038 924432

# check. should be empty
metagene_data_mrna |>  dplyr::filter(pos_fraction > 1 | pos_fraction < 0) # max = 1, min = 0

metagene_data_mrna <- metagene_data_mrna |>
  mutate(pos = case_when(pos_flag == "5UTR" ~ pos_fraction,
                         pos_flag == "CDS" ~ pos_fraction*5 + 1,
                         pos_flag == "3UTR" ~ pos_fraction*5 + 1 + 5 )) # max = 11, min = 0
```

```{r}


metagene_nonmRNA_data <- metagene_data |> 
  dplyr::filter(utr5_len == 0 | utr3_len == 0 & ((start >= start_gene & end<=end_gene & strand_gene == "+") | (start <= start_gene & end>=end_gene & strand_gene == "-")) ) |> 
  dplyr::mutate(pos_fraction = ifelse(strand_gene == "+", (start-start_gene)/width, (start_gene-start)/width)) 

metagene_nonmRNA_data |>  dplyr::filter(pos_fraction > 1 | pos_fraction < 0) # max = 1, min = 0
```




```{r}
box_label <- as_tibble(data.frame(cut_pos = c(0, 1, 6, 11), y = c(1,1,1,1)))
box_label_plot <- ggplot(data = box_label, mapping = aes(x = cut_pos, y = y)) + 
  geom_segment(aes(x = 0, xend = 11, y = 0.5, yend=0.5)) +
  geom_rect(mapping=aes(xmin=1, xmax=6, ymin=0, ymax=1), fill = "gray", color = "black") +
  geom_text(mapping = aes(x = 0.5, y = 0.5, vjust=-0.05, label = "5'UTR")) +
  geom_text(mapping = aes(x = 3.5, y = 0.5, vjust=-0.05, label = "CDS")) +
  geom_text(mapping = aes(x = 8.5, y = 0.5, vjust=-0.05, label = "3'UTR")) +
  theme_minimal() + 
  ylab(  c("")  )  +
  scale_y_continuous(breaks = pretty(c(0:1), n = 2)) +
  #eliminates background, gridlines, and chart border
  theme(
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.y.left = element_text(color = "white"),
    axis.ticks.y=element_blank(),
    axis.title.x=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank()
  )
  #draws x and y axis line
  theme(axis.line = element_line(color = 'black')) +
       font("xylab",size=15)+  
       font("xy",size=15)+ 
       font("xy.text", size = 15) +  
       font("legend.text",size = 15)+
  rremove("legend.title")

mrna_plot_data <- metagene_data_mrna |> dplyr::mutate(flag = case_when(meth_case == 0 ~ "control",
                                              meth_control == 0 ~ "case",
                                              .default = "both"))
mrna_meta_plot <- ggplot(data = mrna_plot_data, mapping = aes(x = pos)) + 
  # geom_density() +
  geom_density(data = mrna_plot_data , mapping = aes(color = flag),show_guide=FALSE)+
  stat_density(data = mrna_plot_data , aes(colour=flag), 
               geom="line",position="identity") + 
  geom_vline(xintercept = c(1, 6), linetype = "dashed", color = "gray") +
  theme_bw() +
  #eliminates background, gridlines, and chart border
  theme(
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(), 
    axis.title.x=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank(),
    legend.position="bottom"
  ) +
       font("xylab",size=15)+  
       font("xy",size=15)+ 
       font("xy.text", size = 15) +  
       font("legend.text",size = 15)+
  xlim(0,11) +
  #draws x and y axis line
  theme(axis.line = element_line(color = 'black')) +
  ylab(  c("Density")  )  +
  rremove("legend.title")

ggarrange(mrna_meta_plot, box_label_plot, ncol = 1, nrow = 2, heights = c(10, 1))

```
Next we would like to know a specific gene which is heavily modified when exposed in hypoxia. according to: https://ncbi.nlm.nih.gov/pmc/articles/PMC5558913/#:~:text=Effect%20of%20hypoxia%20on%20cellular,breast%20cancer%20stem%20cell%20phenotypes
MYC is one of those gene which is more stable in hypoxia condition. In terms of m6A, it is hypothesized that it should hav elower m6A level and potentially lots of 0s sites in case condition
```{r}
annotated_hypoxia_Hela |> dplyr::filter(gene=="MYC") #GLUT, JUN, MYC
```


```{r}
library(Gviz)
plot_tx <- makeTxDbFromUCSC( genome="hg38", tablename="knownGene", transcript_ids="ENST00000621592.8", url="http://genome.ucsc.edu/cgi-bin/")
gtrack <- GenomeAxisTrack()
dtrack_case <- DataTrack(GRanges(metagene_data_mrna |> dplyr::filter(gene=="MYC") |> dplyr::select(seqnames, start, end, strand, meth_case)),
                    genome = "hg38", name = "Hypoxia m6A level", type = "h")
dtrack_control <- DataTrack(GRanges(metagene_data_mrna |> dplyr::filter(gene=="MYC") |> dplyr::select(seqnames, start, end, strand, meth_control)),
                    genome = "hg38", name = "Control m6A level", type = "h")
ht1 <- HighlightTrack(trackList = list(dtrack_case, dtrack_control), col="white",
                     start = c(127736231,  127737931,  127739331, 127740580), width = 550, chromosome = "chr8")
grtrack <- GeneRegionTrack(
    plot_tx,
    chromosome = "chr8", start = 127736231, end = 127742951,
    name = "",
    shape = "smallArrow",
    transcriptAnnotation = "symbol"
)

plotTracks(
    list(ht1, grtrack, gtrack), start = 127736231, end = 127742951,
    background.title = "white", col.axis="#808080", col.title="#808080", fontsize=14, cex=0.9
)

```


```{r}
tuning_summary <- read.csv("ray_results/fixed_tuning/results_summary.csv") |> 
  dplyr::select(avg_val_loss, avg_val_control_pearson_corr, avg_val_case_pearson_corr, iterations_since_restore, starts_with("config.") )
head(tuning_summary)

tuning_summary |> 
  dplyr::select(c(avg_val_loss, iterations_since_restore, starts_with("config."))) |> 
  dplyr::rename(iter = iterations_since_restore, lr = config.lr, weight_decay = config.weight_decay,
                first_filter = config.cnn_first_filter,
                first_ks = config.cnn_first_kernel_size,
                cnn_length = config.cnn_length,
                other_filter = config.cnn_filter,
                other_kernel_size = config.cnn_kernel_size,
                bilstm_layer = config.bilstm_layer,
                bilstm_hidden_size = config.bilstm_hidden_size,
                first_fc_size = config.fc_size) |> 
  dplyr::arrange(avg_val_loss) |> 
  head(20) |> 
  kableExtra::kbl(format= "latex",
                  align="r") |> 
  kableExtra::kable_minimal(full_width = F,  html_font = "Source Sans Pro")
```






Analysis what kind of gene which is has zero on control or zero in hypoxia and the intersect 
```{r}
human_txDb <- makeTxDbFromGFF(paste0(DATA_FOLDER, 'annot_ref/gencode.v45.annotation.gtf'))
# Get from rtracklayer to extract metadata
gtf <- rtracklayer::import.gff(con=paste0(DATA_FOLDER, 'annot_ref/gencode.v45.annotation.gtf'), 
                               format="gtf", genome="GRCh38.p14")

metadata <- as.tibble(elementMetadata(gtf)[ , c("gene_id", "gene_name", 
                                                "gene_type", "transcript_id", 
                                                "transcript_name")])
metadata <- na.omit(metadata)
metadata <- metadata[!duplicated(metadata), ]

# Tx
human_Tx <- transcripts(human_txDb)
# Transcript length summary
human_Tx_length <- transcriptLengths(human_txDb,
                                     with.cds_len=TRUE, with.utr5_len=TRUE, with.utr3_len=TRUE)


human_Tx_data <- S4Vectors::merge(human_Tx, metadata, 
                                  by.x = 'tx_name', by.y = 'transcript_id', all.x=TRUE)
human_Tx_data <- S4Vectors::merge(human_Tx_data, human_Tx_length |> 
                                    dplyr::select(tx_name, nexon, tx_len,cds_len, utr5_len, utr3_len), 
                                  by.x = 'tx_name', by.y = 'tx_name', all.x=TRUE)

# Filtering the longest transcript (width) only for each gene
# it still contain numbers of non mRNA gene: i.e. rRNA, tRNA, Mt_RNA, etc.
human_Tx_data_longest <- human_Tx_data |> 
  dplyr::group_by(gene_id) |> 
  dplyr::filter(width == max(width)) |> 
  # Since several transcripts could have the same start and end.
  # need to filter by tx_len (CDS + UTRs)
  dplyr::filter(tx_len == max(tx_len)) |> 
  dplyr::ungroup() |> 
  # STILL CONTAIN DUPLICATE. CHECK: human_Tx_data_longest |>  dplyr::inner_join(human_Tx_data_longest |> dplyr::select(gene_name, gene_type) |> group_by(gene_name) |> dplyr::summarise(count = dplyr::n()) |> dplyr::filter(count>1), by=c("gene_name")) |> arrange(gene_name,tx_id)
  # Thus add filter below
  dplyr::group_by(gene_name) |>
  dplyr::filter(gene_id == max(gene_id)) |> 
  dplyr::ungroup() |> 
  dplyr::group_by(gene_name) |>
  dplyr::filter(cds_len == max(cds_len)) |> 
  dplyr::ungroup() |> 
  # Arbitary filter by tx_name since they already have the save width, cds len
  dplyr::group_by(gene_name) |>
  dplyr::filter(tx_name == max(tx_name)) |> 
  dplyr::ungroup() |> 
  dplyr::select(!c(tx_id)) |> 
  dplyr::rename('tx_name'='transcript_name', 'tx_id'='tx_name') |> 
  dplyr::relocate(c('tx_id','tx_name','nexon','tx_len'), 
                  .after = c('strand'))
# FILTERINGMISC, VAULT, TO BE CONFIRMED (TEC), ANTIBODY GENES 
#human_Tx_data_longest |> dplyr::filter(!grepl('vault|TEC|artifact', gene_type)) |> dplyr::distinct(gene_type)
```



```{r}
hela_union <- hela_raw_intrsct |> 
  dplyr::full_join(hela_raw_hypoxia_intrsct, by=c("Chr", "Sites"), suffix=c(".control", ".hypoxia")) |> 
  dplyr::mutate(Gene = ifelse(is.na(Gene.control), Gene.hypoxia, Gene.control),
                flag = case_when(is.na(Gene.control) ~ "Hypoxia Only",
                                 is.na(Gene.hypoxia) ~ "Control Only",
                                 .default = "Both")) |> 
  dplyr::left_join(human_Tx_data_longest |> dplyr::select(gene_name, gene_type, tx_id, width),
                                                                   by=dplyr::join_by(Gene==gene_name)) 

# We want to try to reannotated "ELSE" so that it might be useful for us
temp <- (hela_union |> dplyr::filter(Gene=="ELSE") |> dplyr::select(!c(gene_type, tx_id, width))) |> 
  dplyr::left_join(human_Tx_data_longest |> 
                     dplyr::filter(!grepl('vault|TEC|artifact', gene_type)) |> 
                     dplyr::select(seqnames, start, end, gene_name, gene_type, tx_id, width),
                   by=dplyr::join_by(Chr==seqnames, Sites>=start, Sites<=end)) |> 
  dplyr::select(!c(start,end)) |> group_by(Chr, Sites) |> 
    summarise(
        gene_name = paste(gene_name, sep = ";", collapse = "|"),
        gene_type = paste(gene_type, sep = ";", collapse = "|"),
        tx_id = paste(tx_id, sep = ";", collapse = "|"),
        width = paste(width, sep = ";", collapse = "|")
    )

# Overlapped sites with more than one gene separated by |
# There are 4k "ELSE" sites overlap with several genes 
hela_union_else_annotated <- (hela_union |> dplyr::filter(Gene=="ELSE") |> dplyr::select(!c(gene_type, tx_id, width))) |> 
  dplyr::left_join(temp, by=c("Chr", "Sites")) |> dplyr::mutate(Gene = ifelse(gene_name=="NA", "ELSE", gene_name), gene_type = dplyr::na_if(gene_type, "NA"), tx_id = dplyr::na_if(tx_id, "NA"), width = dplyr::na_if(width, "NA")) |> dplyr::select(!(gene_name)) |> dplyr::mutate(width = as.integer(width))

hela_union <- hela_union |> dplyr::filter(Gene!="ELSE") |> bind_rows(hela_union_else_annotated)
```

```{r}
hela_union |> count(flag)

# First report what kind of sites we dont' annotated "ELSE"
hela_union |> dplyr::filter(Gene=="ELSE") |> 
  group_by(Chr) |> count(flag) |> arrange(desc(n))
# We can see that many of "ELSE" comes from the control only and comes from Chr1 and Chr2\
# One example of the region from Control only is chr1:23559529 1k in promoter 
```


```{r}
# Now we wnat to see what kind of genes are in control only
hela_union |> dplyr::filter(flag=="Control Only") |> count(gene_type) |> arrange(desc(n))
hela_union |> dplyr::filter(flag=="Hypoxia Only") |> count(gene_type) |> arrange(desc(n))


# Now we wnat to see what kind of genes are in hypoxia only
#hela_union |> dplyr::filter(flag=="Hypoxia Only") |> distinct(Gene, gene_type)
# Here is the list of the genes which related into the hypoxia response
# We can see that VEGFA sites are mostly detected on hypoxia condition only 
# However, most of the sites are there both in control and hypoxia
hela_union |>dplyr::filter(grepl("HIF|IRS3|VEGFA|EGLN", Gene)) |> group_by(Gene) |> count(flag)
```

# TODO: HOW TO SUMMARISE THOSE MANY GENES ON THE SITES? 





```{r}
venn_hel_intrsct_supp_data <- list(
  supplementary_hypoxia = paste0(hypoxia_HeLa$chr, "_", hypoxia_HeLa$start),
  control_raw_intersect =  base::intersect(venn_hel_data$control_1, venn_hel_data$control_2),
  hypoxia_raw_intersect = base::intersect(venn_hel_data$hypoxia_1, venn_hel_data$hypoxia_2)
)
ggvenn(
  venn_hel_intrsct_supp_data, 
  fill_color = c("#0073C2FF","#CD534CFF", "#EFC000FF"),
  stroke_size = 0.5, set_name_size = 4
  )
```
```{r}
library(venneuler) 
vd <- venneuler(c(A=0.3, B=0.3, C=1.1, "A&B"=0.1, "A&C"=0.2, "B&C"=0.1 ,"A&B&C"=0.1))
plot(vd)
# same as c(A=1, `A&B&C`=1, C=1)
m <- data.frame(elements=c("1","2","2","2","3"), sets=c("A","A","B","C","C"))
v <- venneuler(m)
plot(v)
m <- as.matrix(data.frame(A=c(1.5, 0.2, 0.4, 0, 0),
                          B=c(0  , 0.2, 0  , 1, 0),
                          C=c(0  , 0  , 0.3, 0, 1)))
# without weights
v <- venneuler(m > 0)
plot(v)
# with weights
v <- venneuler(m)
plot(v)
```
```{r}
library(eulerr)

vd <- euler(c(A=10, B=6, "A&B"=6))

plot(vd)
```
```{r}
library(BioVenn)
biovenn <- draw.venn(
  paste0(hypoxia_HeLa$chr, "_", hypoxia_HeLa$start),
  base::intersect(venn_hel_data$control_1, venn_hel_data$control_2),
  base::intersect(venn_hel_data$hypoxia_1, venn_hel_data$hypoxia_2),subtitle="coba", nrtype="pct")
```




# Hela-Hypoxia
```{r}
#hypoxia_HeLa
#chr    start    end meth_case meth_control meth_diff direction    pvalue      fdr log_lik_ratio  log10pvalue label
#chr1  907102 907102      66.1         38.2      27.9 Hypoxia   0.000999  0.00632     10.8    3.00   Up-regula…
hela_1  |> dplyr::filter(Chr == "chr1", Sites == 185038) # Ratio 0.42553 0.411662
hela_2 |> dplyr::filter(Chr == "chr1", Sites == 185038) # Ratio 0.33333 0.3214235
hypox_hela_1 |> dplyr::filter(Chr == "chr1", Sites == 185038) # Ratio 0.68182 NormeRatio 0.6509131
hypox_hela_2 |> dplyr::filter(Chr == "chr1", Sites == 185038) # Ratio 0.64706 NormeRatio 0.6290264	

# Meean hypox hela 0.664
# mean hela 0.42553 
```

```{r}
# List of file paths
library(methylSig)
library(bsseq)

# genomic positions, including chromosome and location, for methylation loci.
# a (matrix) of M (Methylation) values, describing the number of read supporting methylation covering a single loci. Each row in this matrix is a methylation loci and each column is a sample.
# a (matrix) of Cov (Coverage) values, describing the total number of reads covering a single loci. Each row in this matrix is a methylation loci and each column is a sample.

temp <- hela_1 |> dplyr::select(Chr, Sites, Ratio, Acov, AGcov) |> 
  inner_join(hela_2 |>  
               dplyr::select(Chr, Sites, Ratio, Acov, AGcov), 
             by = dplyr::join_by(Chr==Chr, Sites==Sites)) |> 
  inner_join(hypox_hela_1 |>
               dplyr::select(Chr, Sites, Ratio, Acov, AGcov), 
             by = dplyr::join_by(Chr==Chr, Sites==Sites)) |> 
  inner_join(hypox_hela_2 |>
               dplyr::select(Chr, Sites, Ratio, Acov, AGcov), 
             by = dplyr::join_by(Chr==Chr, Sites==Sites)) 

M <- cbind(temp$Acov.x, temp$Acov.y, temp$Acov.x.x, temp$Acov.y.y)
Cov <- cbind(temp$AGcov.x, temp$AGcov.y, temp$AGcov.x.x, temp$AGcov.y.y)
BStmp <- BSseq(chr = temp$Chr, pos = temp$Sites, 
               M = M, Cov = Cov, sampleNames = c("hela_1","hela_2", "hypox_hela_1", "hypox_hela_2"))

head(bsseq::getCoverage(BStmp, type = 'M'))
#hela_1 |> dplyr::filter(Acov==2221)
head(bsseq::getCoverage(BStmp, type = 'Cov'))

colData <- DataFrame(condition = c("control","control","hypox","hypox"),
                     replicate = c(1, 2, 1, 2))

pData(BStmp) <- colData
pData(BStmp)
# Require at least two samples from control and two samples from hypox
bsseq_data_filtered = filter_loci_by_group_coverage(
    bs = BStmp,
    group_column = 'condition',
    c('control' = 1, 'hypox' = 1))
# Methylation matrix
#head(bsseq::getCoverage(combined_BSseq_filtered, type = 'M'))
#ef_1 |> dplyr::filter(Acov==2221)
#head(bsseq::getCoverage(combined_BSseq_filtered, type = 'Cov'))
#GenomicRanges::granges(combined_BSseq_filtered)

diff_gr_hypox = diff_methylsig(
    bs = bsseq_data_filtered,
    disp_groups = c('case' = TRUE, 'control' = TRUE),
    group_column = 'condition',
    comparison_groups = c('case' = 'hypox', 'control' = 'control'),
    n_cores=3)

diff_gr_hypox
```
```{r}
diff_df_hypox <- as.tibble(as.data.frame(diff_gr_hypox))
diff_df_hypox |> dplyr::inner_join(hypoxia_HeLa, by = dplyr::join_by(seqnames==seqnames, start==start, end==end))
```
Able to reproduce but not all sites! (notice the dimension)

```{r}
ggvenn(
  list(
    supplementary_hypoxia = paste0(hypoxia_HeLa$seqnames, hypoxia_HeLa$start),
    methylsig_hypoxia =  paste0(diff_df_hypox$seqnames, diff_df_hypox$start)
    ), 
  fill_color = c("#0073C2FF","#CD534CFF", "#EFC000FF"),
  stroke_size = 0.5, set_name_size = 4
  )
```


```{r}
ggplot(data=hypoxia_HeLa) +
  
```




# MEF-Heatshock 
```{r}
temp <- mef_1 |> select(Chr, Sites, Ratio, Acov, AGcov) |> 
  inner_join(mef_2 |>  
               select(Chr, Sites, Ratio, Acov, AGcov), 
             by = dplyr::join_by(Chr==Chr, Sites==Sites)) |> 
  inner_join(hs_mef_1 |>
               select(Chr, Sites, Ratio, Acov, AGcov), 
             by = dplyr::join_by(Chr==Chr, Sites==Sites)) |> 
  inner_join(hs_mef_2 |>
               select(Chr, Sites, Ratio, Acov, AGcov), 
             by = dplyr::join_by(Chr==Chr, Sites==Sites)) 

M <- cbind(temp$Acov.x, temp$Acov.y, temp$Acov.x.x, temp$Acov.y.y)
Cov <- cbind(temp$AGcov.x, temp$AGcov.y, temp$AGcov.x.x, temp$AGcov.y.y)
BStmp <- BSseq(chr = temp$Chr, pos = temp$Sites, 
               M = M, Cov = Cov, sampleNames = c("mef_1","mef_2", "hs_mef_1", "hs_mef_2"))

head(bsseq::getCoverage(BStmp, type = 'M'))
#mef_1 |> dplyr::filter(Acov==2221)
head(bsseq::getCoverage(BStmp, type = 'Cov'))

colData <- DataFrame(condition = c("control","control","hs","hs"),
                     replicate = c(1, 2, 1, 2))

pData(BStmp) <- colData
pData(BStmp)
# Require at least two samples from control and two samples from hs
bsseq_data_filtered = filter_loci_by_group_coverage(
  bs = BStmp,
  group_column = 'condition',
  c('control' = 1, 'hs' = 1))
# Methylation matrix
#head(bsseq::getCoverage(combined_BSseq_filtered, type = 'M'))
#ef_1 |> dplyr::filter(Acov==2221)
#head(bsseq::getCoverage(combined_BSseq_filtered, type = 'Cov'))
#GenomicRanges::granges(combined_BSseq_filtered)

diff_gr_hs = diff_methylsig(
  bs = bsseq_data_filtered,
  disp_groups = c('case' = TRUE, 'control' = TRUE),
  group_column = 'condition',
  comparison_groups = c('case' = 'hs', 'control' = 'control'),
  n_cores=3)

diff_gr_hs
```

```{r}
diff_df_hs <- as.tibble(as.data.frame(diff_hdiff_gr_hss_mef))
# diff_hs_mef |> inner_join(heat_shock_MEF, by = dplyr::join_by(seqnames==chr, start==start, end==end))
dim(diff_hs_mef)
diff_hs_mef |> dplyr::filter(fdr<0.05)
```

Results are smaller? 
Furthermore, if we filter the diff_hs_mef and diff_hs_hypoxia by the meth_diff (>=$\pm$15%) and fdr<0.05, it will be even smaller!
Therefore, I will go with the original supplementary tables, assuming that the hypoxia and mef were correctly labelled. 




Next, we will look at how the change of methylation level wihtin the stress-induced environment 

# Creating the geneannotation from ENSEMBL
```{r}
# GFF3 data from ENSEMBL FTP 
human_gff_path_ensembl <- 'data/annot_ref/Homo_sapiens.GRCh38.111.gff3'
# Creating ensembldB (MariaDb)
GFF_dB <- ensembldb::ensDbFromGff(human_gff_path_ensembl)
# Converting into EnsDb object
human_TxDb_ensembl <- ensembldb::EnsDb(GFF_dB)
# Get the transcript length from TxDb
human_Tx_length_ensembl <- transcriptLengths(human_TxDb_ensembl,
                  with.cds_len=TRUE, with.utr5_len=TRUE, with.utr3_len=TRUE)

# NOTES:
# 'tx_len' in a lot of cases will not be the same as the 'width' column.
#   The reason behind it is that tx_len not consider intron length.
#   width of a transcript includes the Introns! while tx_len includes cds, utr5 and utr 3 only
# cds_len, utr5_len, utr3_len, hvae values of zero if bio
# tx_cds_seq_start/end has value of NA ()
# Remember that Transcription start upstream of TATA Box (~30%). It also contain several things such as 
# BRE(upstream of TATA) which acts as TFIIB recognition element, INR (initiator element)
# or other promoters such as MTE and DTE which upstream the TSS.
temp_info <- transcripts(human_TxDb_ensembl, 
                         filter=TxIdFilter(rownames(human_Tx_length_ensembl)), 
                         columns=c("tx_name", "gene_id", "gene_name", 
                                   "gene_biotype", 'tx_seq_start', 
                                   'tx_cds_seq_start', 'tx_cds_seq_end', 
                                   'tx_seq_end'))

human_Tx_ensembl_data <- S4Vectors::merge(human_Tx_length_ensembl, temp_info, 
                                    by.x = 'tx_id', by.y = 'tx_name', all.x=TRUE)

# Filtering the longest transcript (width) only for each gene
# it still contain numbers of non mRNA gene: i.e. rRNA, tRNA, Mt_RNA, etc.
human_Tx_ensembl_data <- human_Tx_ensembl_data |> 
  dplyr::group_by(gene_id.x) |> 
  dplyr::filter(width == max(width)) |> 
  # Since several transcripts could have the same start and end.
  # need to filter by tx_len (CDS + UTRs)
  dplyr::filter(tx_len == max(tx_len)) |> 
  dplyr::ungroup() |> 
  dplyr::select(!c(tx_name, gene_id.y, tx_id.y)) |> 
  dplyr::rename('gene_id'='gene_id.x', 'chr'='seqnames') |> 
  dplyr::relocate(c('gene_name','gene_biotype'), .after = c('gene_id')) |> 
  dplyr::relocate(c('tx_id','chr','start','end','width','strand'), 
                  .after = c('gene_biotype'))

rm(temp_info, human_Tx_length_ensembl)
```

# NCBI Annotation
```{r}
# Get GFF 
# More advance version p.14
human_gff_ncbi_path <- 'data/annot_ref/GCF_000001405.40_GRCh38.p14_genomic.gff'
human_gff_ncbi_report_path <- 'data/annot_ref/GCF_000001405.40_GRCh38.p14_assembly_report.txt'

# # Load transcripts DB
human_TxDb_ncbi <- makeTxDbFromGFF(file=human_gff_ncbi_path, format = 'gff3',
                                   organism = 'Homo sapiens')

# # NOTE: GFF from NCBI doesn't contain straight forward chromosome name
# # Thus we need to use the report assembly and the seqnames (RefSeq-Accn)
# # into UCSC-style-name later
human_gff_ncbi_report <- read.csv(human_gff_ncbi_report_path, comment = '#',
                                  sep='\t', header = FALSE,
                                  col.names = c("Sequence-Name","Sequence-Role",
                                                "Assigned-Molecule",
                                                "Assigned-Molecule-Location/Type",
                                                "GenBank-Accn","Relationship",
                                                "RefSeq-Accn","Assembly-Unit",
                                                "Sequence-Length","UCSC-style-name")
                                  )
# # Rename the seqnames (chr) into UCSC style
temp_seq_lvl <- data.frame(seqlevels = seqlevels(human_TxDb_ncbi))
temp_seq_lvl <- temp_seq_lvl |>
  dplyr::left_join(human_gff_ncbi_report |>
                     dplyr::select(RefSeq.Accn, UCSC.style.name),
                   by = dplyr::join_by(seqlevels==RefSeq.Accn)) |>
  dplyr::pull(UCSC.style.name)


# Renaming
seqlevels(human_TxDb_ncbi) <- temp_seq_lvl


# load transcripts GR
human_Tx_ncbi <- transcripts(human_TxDb_ncbi, columns = c("tx_id", "tx_name", "TXTYPE"))
# get length of transcripts
human_Tx_length_ncbi <- transcriptLengths(human_TxDb_ncbi,
                  with.cds_len=TRUE, with.utr5_len=TRUE, with.utr3_len=TRUE)

# Calculating CDS start/end. Reference: https://support.bioconductor.org/p/9154904/
cds_start <- start(human_Tx_ncbi) +
             ifelse(strand(human_Tx_ncbi) == "+", human_Tx_length_ncbi$utr5_len, 
                    human_Tx_length_ncbi$utr3_len)
cds_end   <- end(human_Tx_ncbi)   -
             ifelse(strand(human_Tx_ncbi) == "+", human_Tx_length_ncbi$utr3_len, 
                    human_Tx_length_ncbi$utr5_len)

no_cds_idx <- which(human_Tx_length_ncbi$cds_len == 0L)
cds_start[no_cds_idx] <- NA
cds_end[no_cds_idx]   <- NA

mcols(human_Tx_ncbi)$cds_start <- cds_start
mcols(human_Tx_ncbi)$cds_end   <- cds_end

human_Tx_ncbi_data <- S4Vectors::merge(human_Tx_length_ncbi, human_Tx_ncbi, 
                                       by.x = 'tx_id', by.y = 'tx_id', all.x=TRUE)


# Filtering the longest transcript (width) only for each gene
# it still contain numbers of non mRNA gene: i.e. rRNA, tRNA, Mt_RNA, etc.
human_Tx_ncbi_data <- human_Tx_ncbi_data |> 
  dplyr::group_by(gene_id) |> 
  dplyr::filter(width == max(width)) |> 
  # Since several transcripts could have the same start and end.
  # need to filter by tx_len (CDS + UTRs)
  dplyr::filter(tx_len == max(tx_len)) |> 
  dplyr::ungroup() |> 
  dplyr::select(!c(tx_name.y)) |>
  dplyr::rename('gene_biotype'='TXTYPE',
                'tx_name'='tx_name.x', 'chr'='seqnames') |>
  dplyr::relocate(c('gene_biotype'), .after = c('gene_id')) |>
  dplyr::relocate(c('tx_name','chr','start','end','width','strand'),
                  .after = c('gene_biotype'))

AnnotationDbi::select(human_TxDb_ncbi, keys=human_Tx_ncbi_data$tx_name, 
                      columns='GENEID', keytype = 'TXNAME')
```



Next, we join the annotation information with the data that we have.
```{r}
# annot <- human_Tx_ensembl_data |>
#     dplyr::filter(!is.na(gene_name)) |>
#     dplyr::select(gene_name, gene_biotype, tx_id, chr, start, end) |>
#     dplyr::mutate(chr = as.character(chr))

# annot <- hela_1 |> 
#   # Change into ENSEMBL format
#   dplyr::rowwise() |> 
#   dplyr::mutate( chr=ifelse(strsplit(as.character(Chr), "chr")[[1]][2] == "M", "MT",
#                             strsplit(as.character(Chr), "chr")[[1]][2]), 
#                  start=Sites, end=Sites)

annot <- human_Tx_ncbi_data |>
  # Change into ENSEMBL format
  dplyr::rowwise() |>
  dplyr::mutate( chr=ifelse(strsplit(as.character(chr), "chr")[[1]][2] == "M", "MT",
                            strsplit(as.character(chr), "chr")[[1]][2])) |>
  dplyr::select(gene_id, gene_biotype, tx_name, chr, start, end)

annotated_hypoxia_Hela <- fuzzyjoin::genome_join(
  hypoxia_HeLa |> 
    # Change into ENSEMBL format
    dplyr::rowwise() |> 
    dplyr::mutate( chr=ifelse(strsplit(as.character(chr), "chr")[[1]][2] == "M",
                              "MT", 
                              strsplit(as.character(chr), "chr")[[1]][2])),
  
    annot,
  by = c("chr", "start", "end"), 
  mode = "left"
)

annotated_heat_shock_MEF <- fuzzyjoin::genome_join(
  heat_shock_MEF |> 
    # Change into ENSEMBL format
    dplyr::rowwise() |> 
    dplyr::mutate( chr=ifelse(strsplit(as.character(chr), "chr")[[1]][2] == "M",
                              "MT", 
                              strsplit(as.character(chr), "chr")[[1]][2])),
  
    annot,
  by = c("chr", "start", "end"), 
  mode = "left"
)
head(annotated_hypoxia_Hela)
head(annotated_heat_shock_MEF)
```

```{r}
#ENSEMBL
# Hypox related gene
# Heat Shock related gene
annotated_hypoxia_Hela |> dplyr::filter(str_detect(gene_name, "(?i)^(HIF|EPAS|VEGFA|EGLN3|IRS3)"), 
                                 gene_biotype=="protein_coding", label!="Unchanged m6A")
annotated_hypoxia_Hela |> dplyr::filter(str_detect(gene_name, "(?i)^(HSF|HSP|BAG3|DNAJ)"), 
                                 gene_biotype=="protein_coding", label!="Unchanged m6A")



annotated_heat_shock_MEF |> dplyr::filter(str_detect(gene_name, "(?i)^(HIF|EPAS|VEGFA|EGLN3|IRS3)"), 
                                 gene_biotype=="protein_coding", label!="Unchanged m6A")
annotated_heat_shock_MEF |> dplyr::filter(str_detect(gene_name, "(?i)^(HSF|HSP|BAG3|DNAJ)"), 
                                 gene_biotype=="protein_coding", label!="Unchanged m6A")
```
Seems like heatshock regulated gene are dynamics?



```{r}
#NCBI
# Hypox related gene
# Heat Shock related gene

dynamic_hypo_data_hypo <- annotated_hypoxia_Hela |> dplyr::filter(str_detect(gene_id, "(?i)^(HIF|EPAS|VEGFA|EGLN3|IRS3)"), 
                                 label!="Unchanged m6A")
dynamic_hs_data_hypo <- annotated_hypoxia_Hela |> dplyr::filter(str_detect(gene_id, "(?i)^(HSF|HSP|BAG3|DNAJ)"), 
                                 label!="Unchanged m6A")



dynamic_hypo_data_hs <- annotated_heat_shock_MEF |> dplyr::filter(str_detect(gene_id, "(?i)^(HIF|EPAS|VEGFA|EGLN3|IRS3)"), 
                                 label!="Unchanged m6A")
dynamic_hs_data_hs <- annotated_heat_shock_MEF |> dplyr::filter(str_detect(gene_id, "(?i)^(HSF|HSP|BAG3|DNAJ)"), 
                                 label!="Unchanged m6A")

head(dynamic_hypo_data_hypo)
head(dynamic_hs_data_hypo)
head(dynamic_hypo_data_hs)
head(dynamic_hs_data_hs)
```

What kind of annotation that we need to use?
- NCBI seems containt more txs but ENSEMBL seems more structured



```{r}
#NCBI
hypo_genes_hypo <- dynamic_hypo_data_hypo |> dplyr::filter(gene_biotype=="mRNA", label!="Unchanged m6A") |> distinct(gene_id) |> pull()
hs_genes_hypo <- dynamic_hs_data_hypo |> dplyr::filter(gene_biotype=="mRNA", label!="Unchanged m6A") |> distinct(gene_id) |> pull()


plot_data <- annotated_hypoxia_Hela |> 
  dplyr::filter(label!="Unchanged m6A") |> 
  select(gene_id,  chr.x, start.x, meth_control, meth_case) |>
  pivot_longer(cols=starts_with('meth_'), names_to='group') |> 
  rowwise() |> 
  mutate(group=ifelse(group=='meth_control', 'ctrl','case')) |> 
  ungroup()

temp_hypo <- plot_data |> 
  dplyr::filter(gene_id %in% c(hypo_genes_hypo)) |> 
  mutate(note = "hypo_genes")
temp_hs <- plot_data |> 
  dplyr::filter(gene_id %in% c(hs_genes_hypo)) |> 
  mutate(note = "hs_genes")

plot_data <- rbind(temp_hypo, temp_hs)

options(repr.plot.width = 10, repr.plot.height =2) 
ggplot(plot_data |> dplyr::filter(note=="hypo_genes"), aes(x= group, y = value, fill=group)) +  
  geom_jitter(alpha=0.5, width=0.1) +
  geom_boxplot(width=0.1) +  ggtitle(label = "Distribution of m6A rate of Hypo Genes in Hypoxia Condition") +
  facet_grid(cols = vars(gene_id), rows = vars(note)) + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position = "bottom") + 
  guides(fill = FALSE) 
ggplot(plot_data |> dplyr::filter(note=="hs_genes"), aes(x= group, y = value, fill=group)) +  
  geom_jitter(alpha=0.5, width=0.1) +
  geom_boxplot(width=0.1) +  ggtitle(label = "Distribution of dynamic m6A rate of HS Genes in Hypoxia Condition") +
  facet_wrap(ncol =4, nrow=4, facets=vars(gene_id)) + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme_bw() +
  
  guides(fill = FALSE) 
```



```{r}
gr_m6A <- GRanges(seqnames=hypoxia_HeLa$chr, 
                  ranges=IRanges(start=hypoxia_HeLa$start, end=hypoxia_HeLa$end),
                  m6A_rate=hypoxia_HeLa$meth_diff) 

tr <- transcriptsBy(human_TxDb_ncbi, by = "gene")[["HIF3A"]]


# Create a TranscriptTrack
transcript_track <- TranscriptTrack(
  transcript,
  name = "Transcript Structure",
  showId = TRUE,
  stacking = "dense"
)

# Data track for m6A sites
m6Atrack <- DataTrack(
  range = gr_m6A,
  type = "hist",
  col = "red",
  col.histogram = "red"
)

```



```{r}
library(Gviz)
#genome : "hg19" 
gen<-genome(human_TxDb_ncbi)
#Chromosme name : "chr7"
chr <- as.character(seqlevels(human_TxDb_ncbi))
#Ideogram track
itrack <- IdeogramTrack(genome = gen, chromosome = "chr2")
gtrack <- GenomeAxisTrack()
plotTracks(
  list(transcriptTrack, m6Atrack, gtrack),
  from = min(start(gr_m6A)),
  to = max(end(gr_m6A)),
  chromosome = as.character(unique(seqnames(gr_m6A)))
)
```




```{r}
# txdb <- loadDb(samplefile)
txTr <- GeneRegionTrack(human_TxDb_ensembl, chromosome = "chr6", start = 300000, end = 350000)
#feature(txTr)
plotTracks(txTr)
```



```{r}
# Save the guitarTxdb to be loaded later
save(human_TxDb, file = 'human_GuitarTxdb')
```


```{r}
human_TxDb <-  makeTxDbFromGFF(file=human_gff_path_ensembl, format = 'gff3',
                               organism = 'Homo sapiens')
human_TxDb <-  makeTxDbFromGFF(file=human_gff_path_ensembl, format = 'gff3',
                               organism = 'Homo sapiens')
human_GuitarTxdb <- Guitar::makeGuitarTxdb(human_TxDb)

# Save the guitarTxdb to be loaded later
save(human_TxDb, file = 'human_GuitarTxdb')
```

```{r}
## NED TO CHANGE INTO ENSEMBL MODE # 1,2, MT, Y, X
temp_m6A_bed <- overlap_repl_sites |> 
  dplyr::mutate(stop = sites) |> 
  dplyr::rowwise() |> 
  # Change into ENSEMBL format
  dplyr::mutate(name = paste0('m6A_',chr,'_',sites), 
                CHR=ifelse(strsplit(as.character(chr), "chr")[[1]][2] == "M",
                       "MT", 
                       strsplit(as.character(chr), "chr")[[1]][2]),
                avg_m6a = avg_m6a*100) |> 
  dplyr::ungroup() |> 
  #dplyr::arrange(CHR,sites,stop) |> 
  dplyr::rename(start=sites) |> 
  dplyr::select(CHR, start, stop, name, avg_m6a, strand) 

# Writing into bed file 
m6A_overlap_bed <- GenomicRanges::makeGRangesFromDataFrame(temp_m6A_bed)
m6A_overlap_bed <- rtracklayer::export(m6A_overlap_bed, format="bed", ignore.strand = FALSE)
write.table(m6A_overlap_bed, "data/m6A_overlap.bed", sep="\t", col.names=FALSE,
            row.names = FALSE, quote = FALSE)

# Overlapping with 
```


```{r}

human_TxDb <- makeTxDbFromGFF(file='data/annot_ref/hg38.knownGene.gtf', format = 'gtf',
                                   organism = 'Homo sapiens')
```

```{r}
## UCSC Format
temp_m6A_bed <- overlap_repl_sites |> 
  dplyr::mutate(stop = sites) |> 
  dplyr::rowwise() |> 
  # Change into ENSEMBL format
  dplyr::mutate(name = paste0('m6A_',chr,'_',sites),
                avg_m6a = avg_m6a*100) |> 
  dplyr::ungroup() |> 
  #dplyr::arrange(CHR,sites,stop) |> 
  dplyr::rename(start=sites) |> 
  dplyr::select(chr, start, stop, name, avg_m6a, strand) 

# Writing into bed file 
m6A_overlap_bed <- GenomicRanges::makeGRangesFromDataFrame(temp_m6A_bed)
m6A_overlap_bed <- rtracklayer::export(m6A_overlap_bed, format="bed", ignore.strand = FALSE)
write.table(m6A_overlap_bed, "data/GLORI_data/m6A_overlap.bed", sep="\t", col.names=FALSE,
            row.names = FALSE, quote = FALSE)
```

```{r}

# if Error in reduce(txWithFlank) : argument ".f" is missing, with no default --> unload purrr package. conflict namespace
GuitarPlot(txGTF = 'data/GLORI_data/inst_extdata_others_hg19_toy.gtf',
          #mapFilterTranscript=FALSE,
           stBedFiles = 'data/GLORI_data/m6A_overlap.bed', enableCI=FALSE)
```


```{r}
GuitarPlot(txGTF = makeTxDbFromUCSC(),
          #mapFilterTranscript=FALSE,
           stBedFiles = 'data/GLORI_data/m6A_overlap_ensembl.bed', pltTxType = c("mrna"),
          enableCI=FALSE)
```



```{r}
# if Error in reduce(txWithFlank) : argument ".f" is missing, with no default --> unload purrr package. conflict namespace
GuitarPlot(txTxdb = human_TxDb,
          #mapFilterTranscript=FALSE, 
          adjust=5,
          stGroupName = c('HEK293T'),
           stBedFiles = 'data/GLORI_data/m6A_overlap.bed', pltTxType = c("mrna"),
          enableCI=FALSE)
```
```{r}
GuitarPlot(txTxdb = human_txDb_gencode,
          #mapFilterTranscript=FALSE, 
          adjust=5,
          stGroupName = c('HEK293T'),
           stBedFiles = 'data/GLORI_data/m6A_overlap.bed', pltTxType = c("mrna"),
          enableCI=FALSE)
```




# FROM NCBI 
```{r}
# Get GFF 
# Incorrect chr info for NCBI gff? https://www.biostars.org/p/9552902/
# More advance version p.14
human_gff_ncbi_path <- 'data/annot_ref/GCF_000001405.40_GRCh38.p14_genomic.gff'
human_gff_ncbi_report_path <- 'data/annot_ref/GCF_000001405.40_GRCh38.p14_assembly_report.txt'

# # Load transcripts DB
human_TxDb_ncbi <- makeTxDbFromGFF(file=human_gff_ncbi_path, format = 'gff3',
                                   organism = 'Homo sapiens')

# # NOTE: GFF from NCBI doesn't contain straight forward chromosome name
# # Thus we need to use the report assembly and the seqnames (RefSeq-Accn)
# # into UCSC-style-name later
human_gff_ncbi_report <- read.csv(human_gff_ncbi_report_path, comment = '#',
                                  sep='\t', header = FALSE,
                                  col.names = c("Sequence-Name","Sequence-Role",
                                                "Assigned-Molecule",
                                                "Assigned-Molecule-Location/Type",
                                                "GenBank-Accn","Relationship",
                                                "RefSeq-Accn","Assembly-Unit",
                                                "Sequence-Length","UCSC-style-name")
                                  )
# # Rename the seqnames (chr) into UCSC style
temp_seq_lvl <- data.frame(seqlevels = seqlevels(human_TxDb_ncbi))
temp_seq_lvl <- temp_seq_lvl |>
  dplyr::left_join(human_gff_ncbi_report |>
                     dplyr::select(RefSeq.Accn, UCSC.style.name),
                   by = dplyr::join_by(seqlevels==RefSeq.Accn)) |>
  dplyr::pull(UCSC.style.name)


# # As in GLORI Paper it used GCF_000001405.39
# #https://ftp.ncbi.nlm.nih.gov/refseq/H_sapiens/annotation/annotation_releases/109.20211119/GCF_000001405.39_GRCh38.p13/
# human_gff_ncbi_path <- 'data/p_13/GCF_000001405.39_GRCh38.p13_genomic.gtf'
# human_gff_ncbi_report_path <- 'data/p_13/GCF_000001405.39_GRCh38.p13_assembly_report.txt'
# human_TxDb_ncbi <- makeTxDbFromGFF(file=human_gff_ncbi_path, format = 'gtf',
#                                    organism = 'Homo sapiens')
# 
# 
# # NOTE: GFF from NCBI doesn't contain straight forward chromosome name
# # Thus we need to use the report assembly and the seqnames (RefSeq-Accn) 
# # into UCSC-style-name later
# human_gff_ncbi_report <- read.csv(human_gff_ncbi_report_path, comment = '#', 
#                                   sep='\t', header = FALSE, 
#                                   col.names = c("Sequence-Name","Sequence-Role",
#                                                 "Assigned-Molecule",
#                                                 "Assigned-Molecule-Location/Type",
#                                                 "GenBank-Accn","Relationship",
#                                                 "RefSeq-Accn","Assembly-Unit",
#                                                 "Sequence-Length","UCSC-style-name")
#                                   )
# 
# # Rename the seqnames (chr) into UCSC style
# temp_seq_lvl <- data.frame(seqlevels = seqlevels(human_TxDb_ncbi))
# temp_seq_lvl <- temp_seq_lvl |>  
#   dplyr::left_join(human_gff_ncbi_report |> 
#                      dplyr::select(RefSeq.Accn, UCSC.style.name) |> 
#                      mutate(UCSC.style.name  = ifelse(UCSC.style.name=="na", paste0('NA_',RefSeq.Accn), UCSC.style.name)),
#                    by = dplyr::join_by(seqlevels==RefSeq.Accn)) |> 
#   dplyr::pull(UCSC.style.name)


# Renaming
seqlevels(human_TxDb_ncbi) <- temp_seq_lvl


# load transcripts GR
human_Tx_ncbi <- transcripts(human_TxDb_ncbi, columns = c("tx_id", "tx_name", "TXTYPE"))
# get length of transcripts
human_Tx_length_ncbi <- transcriptLengths(human_TxDb_ncbi,
                  with.cds_len=TRUE, with.utr5_len=TRUE, with.utr3_len=TRUE)

# Calculating CDS start/end. Reference: https://support.bioconductor.org/p/9154904/
cds_start <- start(human_Tx_ncbi) +
             ifelse(strand(human_Tx_ncbi) == "+", human_Tx_length_ncbi$utr5_len, 
                    human_Tx_length_ncbi$utr3_len)
cds_end   <- end(human_Tx_ncbi)   -
             ifelse(strand(human_Tx_ncbi) == "+", human_Tx_length_ncbi$utr3_len, 
                    human_Tx_length_ncbi$utr5_len)

no_cds_idx <- which(human_Tx_length_ncbi$cds_len == 0L)
cds_start[no_cds_idx] <- NA
cds_end[no_cds_idx]   <- NA

mcols(human_Tx_ncbi)$cds_start <- cds_start
mcols(human_Tx_ncbi)$cds_end   <- cds_end

human_Tx_ncbi_data <- S4Vectors::merge(human_Tx_length_ncbi, human_Tx_ncbi, 
                                       by.x = 'tx_id', by.y = 'tx_id', all.x=TRUE)


# Filtering the longest transcript (width) only for each gene
# it still contain numbers of non mRNA gene: i.e. rRNA, tRNA, Mt_RNA, etc.
human_Tx_ncbi_data <- human_Tx_ncbi_data |> 
  dplyr::group_by(gene_id) |> 
  dplyr::filter(width == max(width)) |> 
  # Since several transcripts could have the same start and end.
  # need to filter by tx_len (CDS + UTRs)
  dplyr::filter(tx_len == max(tx_len)) |> 
  dplyr::ungroup() |> 
  dplyr::select(!c(tx_name.y)) |>
  dplyr::rename('gene_biotype'='TXTYPE',
                'tx_name'='tx_name.x', 'chr'='seqnames') |>
  dplyr::relocate(c('gene_biotype'), .after = c('gene_id')) |>
  dplyr::relocate(c('tx_name','chr','start','end','width','strand'),
                  .after = c('gene_biotype'))

AnnotationDbi::select(human_TxDb_ncbi, keys=human_Tx_ncbi_data$tx_name, 
                      columns='GENEID', keytype = 'TXNAME')

# longest_tx <- list(tx_id = human_Tx_ncbi_data |> dplyr::pull(tx_id))
# longest_mRNA_tx <- list(tx_id = human_Tx_ncbi_data |> 
#                           dplyr::filter(gene_biotype=='mRNA') |> 
#                           dplyr::pull(tx_id)
# 
# 
# exons(human_TxDb_ncbi,filter=longest_tx, columns=c('exon_id', 'tx_name'))
# 


  

# rm(cds_start, cds_end, no_cds_idx, human_Tx_length_ncbi, human_Tx_ncbi)
```
# Join with overlap
```{r}
txfiveutrMinLength = 100
txcdsMinLength = 100
txthreeutrMinLength = 100
txlongNcrnaMinLength = 100
txlncrnaOverlapmrna = FALSE
txpromoterLength = 1000
txtailLength = 1000
txAmblguity = 5
pltTxType =  c("tx","mrna","ncrna")
component <- list()
component$txTypes <- list()

nameFilterTx <- longest_tx$tx_id

tx <- exonsBy(human_TxDb_ncbi, by = "tx")
tx <- tx[longest_tx$tx_id]
txRange <- GenomicRanges::ranges(tx)

##################################################
  # generate components for all transcripts
  ##################################################
  # extract promoter and tail regions
  promoter <- flank(txRange, txpromoterLength, start=TRUE)
  tail <- flank(txRange, txtailLength, start=FALSE)
  
  # contruct transcripts with promoter and tail
  txGRange <- unlist(tx)
  mcols(txGRange) <- NULL    #promoter and tail don't have metadata
  txWithFlank_gr <- c(as(promoter, "GRanges"), txGRange,as(tail, "GRanges"))
  txWithFlank <- split(txWithFlank_gr, names(txWithFlank_gr))
  txWithFlank <- reduce(txWithFlank)
  
  for(txTypes in pltTxType )
  {
    if(txTypes == "tx" )
    {
      
      ##################################################
      # generate components for all tx
      ##################################################
      print("generate components for all tx")
      {
        component$txTypes <- c(component$txTypes, "tx")
        #component$tx$componentTypes <- ()
        component[[txTypes]]$componentTypes <- c("promoter", "rna", "tail")
        
        component[[txTypes]]$names <- nameFilterTx
        component[[txTypes]]$txWithFlank <- txWithFlank
        component[[txTypes]]$txWithFlank_len <- sum(width(component$tx$txWithFlank))
        component[[txTypes]]$tx <- tx
        component[[txTypes]]$promoter <- promoter
        component[[txTypes]]$rna <- tx
        component[[txTypes]]$tail <- tail
        
        component[[txTypes]]$txRange <- txRange
      }
    }
    ##################################################
    # generate components for mRNA
    ##################################################
    if(txTypes == "mrna" )
    {
      print("generate components for mRNA")
      if (length(longest_tx) > 0)
      { 
        component$txTypes <- c(component$txTypes, "mrna")
        component[[txTypes]]$componentTypes <- c("promoter", "utr5", "cds", "utr3", "tail")
        
        component[[txTypes]]$names <- longest_tx
        component[[txTypes]]$txWithFlank <- txWithFlank[longest_tx]
        component[[txTypes]]$txWithFlank_len <- sum(width(component$mrna$txWithFlank))
        component[[txTypes]]$tx <- tx[longest_tx]
        component[[txTypes]]$promoter <- promoter[longest_tx]
        component[[txTypes]]$utr5 <- utr5[longest_tx]
        component[[txTypes]]$cds <- cds[longest_tx]
        component[[txTypes]]$utr3 <- utr3[longest_tx]
        component[[txTypes]]$tail <- tail[longest_tx]
      }
    }
    ##################################################
    # generate components for lncRNA
    ##################################################
    if(txTypes == "ncrna" )
    {
      print("generate components for lncRNA")
      if (length(nameFilterncRNA) > 0)
      {
        component$txTypes <- c(component$txTypes, "ncrna")
        component[[txTypes]]$componentTypes <- c("promoter", "ncrna", "tail")
        
        component[[txTypes]]$names <- nameFilterncRNA
        component[[txTypes]]$txWithFlank <- txWithFlank[nameFilterncRNA]
        component[[txTypes]]$txWithFlank_len <- sum(width(component$ncrna$txWithFlank))
        component[[txTypes]]$tx <- tx[nameFilterncRNA]
        component[[txTypes]]$promoter <- promoter[nameFilterncRNA]
        component[[txTypes]]$ncrna <- tx[nameFilterncRNA]
        component[[txTypes]]$tail <- tail[nameFilterncRNA]
      }
    }
  }
  
  ##################################################
  # generate chiped transcriptome
  ##################################################
  print("generate chiped transcriptome")
  rslt <- .generateChipedTranscriptome(component)
  #print(paste(names(rslt), collapse = ", "))
  component$tx$txComponentGRange <- rslt$txComponentGRange
  component$tx$txChipedGRange <- rslt$txChipedGRange
  
```




# Sanity check from RAW GLORI with NCBI GFF3
```{r}
# Checking the inetrsection from RAW GLORI with NCBI p.14
join_raw_GLORI_ncbi <- hypox_hela_1 |> 
  dplyr::left_join(human_Tx_ncbi_data |> 
                     dplyr::select(gene, gene_biotype) |> 
                     dplyr::distinct(gene, gene_biotype), 
                   by = dplyr::join_by(Gene == gene), keep = TRUE)

na_type <- join_raw_GLORI_ncbi |> 
  dplyr::filter(is.na(gene), Gene != 'ELSE')
na_type_gene <- join_raw_GLORI_ncbi |> 
  dplyr::filter(is.na(gene), Gene != 'ELSE') |> 
  dplyr::distinct(Gene)

print(dim(na_type_gene))


# Check in GTF file 
transcripts(human_TxDb_ncbi, columns = c("tx_id", "tx_name", "TXTYPE"),  
            filter=list(gene_id=na_type_gene))
# Nothing. Don't know from where GLORI got additional 930 genes
# But mostly it is pseudogene. I think it comes from different patch version
# p.13 vs p.14
```
Question: why there' sstill missing Genes? when check 



# Metagene analysis of NCBI data 
```{r}
human_Tx_ncbi_premRNA_data <- human_Tx_ncbi_data |>  
  dplyr::filter(!is.na(cds_start)) |> 
  dplyr::rowwise() |> 
  dplyr::mutate(
    utr5_start = start,
    utr5_end =  ifelse(strand == "+", start + utr5_len - 1,
                       start - utr5_len + 1),
    utr3_start = ifelse(strand == "+", cds_end + 1,
                        cds_end - 1),
    utr3_end = end
  ) |> 
  dplyr::ungroup() |> 
  dplyr::relocate(c('utr5_start','utr5_end'), .before = c('cds_start'))

# Now, we want to create relative position of the sites within each gene
# We want to have postiion 0-1 as utr3, 1-2 as cds, and 2-3 as utr5, thus
# we can plot the relative position.

# But first we need to annot

# A tibble: 22,966 × 19
   gene    gene_biotype tx_id          chr     start     end width strand nexon tx_len cds_len utr5_len utr3_len utr5_start utr5_end cds_start cds_end utr3_start utr3_end
   <chr>   <chr>        <chr>          <chr>   <int>   <int> <int> <fct>  <int>  <int>   <int>    <int>    <int>      <int>    <dbl>     <int>   <int>      <dbl>    <int>
 1 OR4F5   mRNA         NM_001005484.2 chr1    65419   71585  6167 +          3   2618     981       60     1577      65419    65478     65479   70008      70009    71585
   
# say we are on 65468 Thus, from start we have: 65468 - utr5_start = 49 
# (49/width)*3 = 0.02383655  

```



# Load NCBI mapped sequence
```{r}
# Docs: https://www.bioconductor.org/packages/2.13/bioc/vignettes/Rsamtools/inst/doc/Rsamtools-Overview.pdf
# Model RefSeq : RNA and protein products that are generated by the eukaryotic genome annotation pipeline. These records use accession prefixes XM_, XR_, and XP_.
#Known RefSeq : RNA and protein products that are mainly derived from GenBank cDNA and EST data and are supported by the RefSeq eukaryotic curation group. These records use accession prefixes NM_, NR_, and NP_.


# Known Refseq accessions prefixed with NM_ and NR_
human_known_seq_ncbi_path <- 'data/seq_ref/GCF_000001405.40_GRCh38.p14_knownrefseq_alns.bam'
# Model Refseq accessions prefixed with XM_ and XR_
# TODO human_model_seq_ncbi_path

# sam file: qname, flag, rname, pos, ...
human_known_seq_ncbi <- scanBam(human_known_seq_ncbi_path, nThreads=4)

# Showing tx name 
intersect_tx <- human_known_seq_ncbi[[1]]$qname

# Only NR and NM for knownrefseq
cc       <- strsplit(human_known_seq_ncbi[[1]]$qname,'_')
part1    <- unlist(cc)[2*(1:length(human_known_seq_ncbi[[1]]$qname))-1]

# TODO: Joining sequence data into the annotation data for training and testeing purpose
```












 
# ENSMBL BiomaRt scratch
```{r echo=FALSE, Univariate_Plots}
write.table(listAttributes(mart), file='list_attr.txt')
coba <- getBM(attributes = c('ensembl_transcript_id', '5_utr_start', '5_utr_end',
                                        '3_utr_start', '3_utr_end', 'genomic_coding_start', 
                                        'genomic_coding_start'),
                         filters = 'ensembl_gene_id',
                         values = 'ENSG00000272438',
                         mart = mart)
# TTN example
getBM(
     attributes = c('hgnc_symbol', 'gene_biotype', 'ensembl_gene_id', 'ensembl_transcript_id', 'ensembl_transcript_id_version'),
     filters = c('chromosome_name', 'start', 'end'),
     values = list(2, 178807422, 178807422),
     mart
 )

# get start stop for each transcript id 
# TTN example
getBM(
     attributes = c('hgnc_symbol','5_utr_start', '5_utr_end'),
     filters = 'ensembl_gene_id',
     values = 'NM_001267550.2',
     mart
 )


attributes <- c('ensembl_transcript_id', 
                '5_utr_start', '5_utr_end', 
                '3_utr_start', '3_utr_end')

# For the sake of example, let's assume `ensembl_transcript_ids` contains the mapped IDs
ids <- c('NM_001101', 'NM_001256799', 'NM_000594')

getBM(attributes = attributes,
                 filters = 'refseq_mrna',
                 values = ids,
                 mart = mart)
```
